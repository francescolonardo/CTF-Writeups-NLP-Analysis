<h1>Old Family Recipe</h1>

<h3>Category: Web Exploitation</h3>

<h3>Author: Joshua Cordeiro-Zebkowitz (Rasenha)</h3>

<h2>Description</h2>

<p>Your team has uncovered an old admin login page that Mom &amp; Pops Flag Shop used to run back in the day. They overhauled their website after buying up all those other shops, but rumour has it that an old family flag was left behind. Forge a path, find the flag, and enjoy your baked goods.</p>

<h2>Hints</h2>

<ol>
<li>Ever had to forge a signature? Flask gives you good practice.</li>
</ol>

<h2>Solution</h2>

<ol>
<li><p>When you first enter the site, you'll be met with a login page. Try and login using username: admin and password: admin. (Could change these for anything, doesn't really matter).</p></li>
<li><p>You'll then see a page saying that the login was incorrect, and to visit one of Mom &amp; Pops' recently acquired companies. In here are a few random names, but one points to 'Robots.txt'.</p></li>
<li><p>Go to the robots.txt page for the site and you'll find that it tells you that your browser is unsupported and point you towards Internet Explorer 6.01.</p></li>
<li><p>The User-Agent for IE 6.01 is "Mozilla/4.0 (compatible; MSIE 6.01; Windows NT 6.0)" (from http://www.useragentstring.com/index.php?id=7730)</p></li>
<li><p>Next you can change your browser's user-agent by (in chromium):</p>

<ul>
<li>Go to 'Inspect'</li>
<li>Click on the 3 dots in the right-hand corner</li>
<li>'More Tools'</li>
<li>'Network Conditions'</li>
<li>Uncheck 'Use browser default'</li>
<li>Enter the User-Agent for IE 6.01</li>
</ul></li>
<li><p>Now, reload the page with the new user-agent and you'll find:</p></li>
</ol>

<p>```
User-agent: *
Disallow: </p>

<h1>Dear Pop,</h1>

<h1>It was awfully nice of those kinda fellas at Omni to help us out with our website, they told me</h1>

<h1>to give them some sorta secret key for the cookies, sounds like they could use a good ol' family recipe.</h1>

<h1>Would you be able to pass this secret key onto them?</h1>

<h1>flour<em>sugar</em>chocolate<em>and</em>lotsalove</h1>

<h1>Love,</h1>

<h1>Mom</h1>

<h1>P.S. I think they may be lost in the giggle juice, talking about their flasks...</h1>

<p>```</p>

<ol start="6">
<li><p>There are some interesting words in here that might catch your eye and that relate to websites: cookies, flasks, and secret keys. If you're familiar with flask and how its session cookies work, you'll know that it signs them rather than encrypting, and to do this a "secret key" is used. If not, googling the key terms should get you a page like this one: https://blog.paradoxis.nl/defeating-flasks-session-management-65706ba9d3ce</p></li>
<li><p>Now you have a the secret key by which the cookies of this site are made: flour<em>sugar</em>chocolate<em>and</em>lotsalove. To obtain your current cookie, you could use 'Inspect' -> Storage -> Cookies and get the value. This is a Base64 encoding of the session data, a time stamp, and a cryptographic hash.</p></li>
<li><p>You can decode the cookie to obtain the session data with a tool like cyberchef: https://gchq.github.io/CyberChef/.</p></li>
</ol>

<p>```
E.g.</p>

<p>eyJhZG1pbiI6ZmFsc2UsInVzZXJuYW1lIjoiYWRtaW4ifQ.Ya2IDw.nr-R-kOeBryBOrcb6Pp0n8oKSq4</p>

<p>Becomes</p>

<p>{"admin":false,"username":"admin"}..Ø.ð.´d9àkÈ.«q¾.§Iü ¤ªä</p>

<p>```</p>

<ol start="9">
<li><p>Since this is the admin account you're trying to access, you probably want to set the 'admin' field to 'true'. Unfortunately, you can't just change it to 'true' and send it off in a POST request because Flask still has the SHA1 hash which is based on the session data, the timestamp, and the secret key. Fortunately, Mom's leaked email gave you the secret key!</p></li>
<li><p>To craft the session cookie, that previous site (https://blog.paradoxis.nl/defeating-flasks-session-management-65706ba9d3ce) gives a good script, into which you just need to add the secret key and some session data for setting admin to true.</p></li>
</ol>

<p>```
import hashlib
from flask import Flask
from itsdangerous import TimestampSigner, URLSafeTimedSerializer
from flask.sessions import TaggedJSONSerializer</p>

<p>session = {"admin":True,"username":"admin"}</p>

<p>def solve():
    s = URLSafeTimedSerializer(
        secret<em>key='flour</em>sugar<em>chocolate</em>and<em>lotsalove',
        salt='cookie-session',
        serializer=TaggedJSONSerializer(),
        signer=TimestampSigner,
        signer</em>kwargs={
            'key<em>derivation': 'hmac',
            'digest</em>method': hashlib.sha1
        }
    )
    return s.dumps(session)
```</p>

<ol start="11">
<li><p>Running this script will give the new session cookie, which you can send to the site by intercepting an HTTP request/using a cookie editor tool.</p></li>
<li><p>Press 'login' on the login page once that new cookie's been put in and VOILA! The Flag!</p></li>
</ol>

<h2>Flag</h2>

<p>magpie{d3l1c10u5<em>h0m3m4d3</em>c00k1e5}</p>
