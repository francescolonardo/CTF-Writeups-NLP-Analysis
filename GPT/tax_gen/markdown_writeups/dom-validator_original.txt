<h1>DOM Validator</h1>

<p><em>Detailed writeup available here: https://medium.com/@terjanq/xss-auditor-the-protector-of-unprotected-f900a5e15b7b</em></p>

<p>We had a simple upload page that allowed you to upload a custom HTML page. You could report suspicious URLs to admin.
After uploading the page we get:
```html</p>

<p><!DOCTYPE html SYSTEM "3b16c602b53a3e4fc22f0d25cddb0fc4d1478e0233c83172c36d0a6cf46c171ed5811fbffc3cb9c3705b7258179ef11362760d105fb483937607dd46a6abcffc">
<html>
    <head>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/sha512.js"></script>
        <script src="../scripts/DOMValidator.js"></script>
    </head>
    <body>
        <h1>test_post</h1>
        <p><script>alert('pwned')</script></p>
    </body>
</html>
```</p>

<p>The <code>&lt;script&gt;alert('pwned')&lt;/script&gt;</code> won't be executed because of the <code>DOMValidator.js</code> script:</p>

<p><code>javascript
function checksum (element) {
    var string = ''
    string += (element.attributes ? element.attributes.length : 0) + '|'
    for (var i = 0; i &lt; (element.attributes ? element.attributes.length : 0); i++) {
        string += element.attributes[i].name + ':' + element.attributes[i].value + '|'
    }
    string += (element.childNodes ? element.childNodes.length : 0) + '|'
    for (var i = 0; i &lt; (element.childNodes ? element.childNodes.length : 0); i++) {
        string += checksum(element.childNodes[i]) + '|'
    }
    return CryptoJS.SHA512(string).toString(CryptoJS.enc.Hex)
}
var request = new XMLHttpRequest()
request.open('GET', location.href, false)
request.send(null)
if (checksum((new DOMParser()).parseFromString(request.responseText, 'text/html')) !== document.doctype.systemId) {
    document.documentElement.remove()
}
</code></p>

<p>It calculates some sort document's hash and then compares it with the original. I haven't even looked into the code because I already knew an unintended solution for this one. </p>

<p>The page wasn't setting any <code>X-XSS-Protection</code> header so the <code>XSS-Auditor</code> in Chrome 74 (that's the version the admin uses) is set to <code>mode=filter</code> so any reflected XSS will be filtered and not executed. </p>

<p>So I appended the <code>xss=&lt;script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/sha512.js"&gt;</code> parameter to the query so the <code>sha512.js</code> script will be filtered and the <code>DOMValidator.js</code> will crash. Hence, <code>&lt;script&gt;alert('pwned')&lt;/script&gt;</code> will be executed.</p>

<p><img src="https://i.imgur.com/gso11nh.png" alt="" /></p>

<p>After sending that URL to the admin we get the flag: <strong>actf{its<em>all</em>relative}</strong></p>
